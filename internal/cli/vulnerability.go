package cli

import (
	"context"
	"fmt"
	"net/url"
	"strconv"

	"github.com/spf13/cobra"
)

func newVulnerabilityCmd() *cobra.Command {
	cmd := &cobra.Command{
		Use:     "vulnerability",
		Aliases: []string{"vuln"},
		Short:   "Manage vulnerabilities",
	}

	cmd.AddCommand(newVulnListCmd())
	cmd.AddCommand(newVulnGetCmd())
	cmd.AddCommand(newVulnScanCmd())
	cmd.AddCommand(newVulnSummaryCmd())
	cmd.AddCommand(newVulnTopCmd())

	return cmd
}

func newVulnListCmd() *cobra.Command {
	var severity, status string

	cmd := &cobra.Command{
		Use:   "list",
		Short: "List vulnerabilities",
		RunE: func(cmd *cobra.Command, args []string) error {
			ctx := context.Background()

			// Use url.Values for proper URL encoding
			query := url.Values{}
			if severity != "" {
				query.Set("severity", severity)
			}
			if status != "" {
				query.Set("status", status)
			}
			
			path := "/api/v1/vulnerabilities"
			if len(query) > 0 {
				path += "?" + query.Encode()
			}

			var result interface{}
			if err := apiClient.DoRaw(ctx, "GET", path, nil, &result); err != nil {
				return fmt.Errorf("failed to list vulnerabilities: %w", err)
			}

			return printOutput(result)
		},
	}

	cmd.Flags().StringVar(&severity, "severity", "", "filter by severity")
	cmd.Flags().StringVar(&status, "status", "", "filter by status")

	return cmd
}

func newVulnGetCmd() *cobra.Command {
	return &cobra.Command{
		Use:   "get <id>",
		Short: "Get vulnerability details",
		Args:  cobra.ExactArgs(1),
		RunE: func(cmd *cobra.Command, args []string) error {
			ctx := context.Background()
			id := args[0]

			var result interface{}
			if err := apiClient.DoRaw(ctx, "GET", "/api/v1/vulnerabilities/"+id, nil, &result); err != nil {
				return fmt.Errorf("failed to get vulnerability: %w", err)
			}

			return printOutput(result)
		},
	}
}

func newVulnScanCmd() *cobra.Command {
	var resourceID string

	cmd := &cobra.Command{
		Use:   "scan",
		Short: "Trigger vulnerability scan",
		RunE: func(cmd *cobra.Command, args []string) error {
			ctx := context.Background()
			fmt.Println("Starting vulnerability scan...")

			body := map[string]interface{}{}
			if resourceID != "" {
				id, err := strconv.ParseInt(resourceID, 10, 64)
				if err != nil {
					return fmt.Errorf("invalid resource ID: %s", resourceID)
				}
				body["resource_id"] = id
			}

			var result interface{}
			if err := apiClient.DoRaw(ctx, "POST", "/api/v1/vulnerabilities/scan", body, &result); err != nil {
				return fmt.Errorf("vulnerability scan failed: %w", err)
			}

			fmt.Println("Scan completed")
			if result != nil {
				return printOutput(result)
			}
			return nil
		},
	}

	cmd.Flags().StringVar(&resourceID, "resource", "", "scan specific resource ID")

	return cmd
}

func newVulnSummaryCmd() *cobra.Command {
	return &cobra.Command{
		Use:   "summary",
		Short: "Show vulnerability summary",
		RunE: func(cmd *cobra.Command, args []string) error {
			ctx := context.Background()

			var summary interface{}
			if err := apiClient.DoRaw(ctx, "GET", "/api/v1/vulnerabilities/summary", nil, &summary); err != nil {
				return fmt.Errorf("failed to get vulnerability summary: %w", err)
			}

			return printOutput(summary)
		},
	}
}

func newVulnTopCmd() *cobra.Command {
	return &cobra.Command{
		Use:   "top",
		Short: "Show top vulnerabilities",
		RunE: func(cmd *cobra.Command, args []string) error {
			ctx := context.Background()

			var result interface{}
			if err := apiClient.DoRaw(ctx, "GET", "/api/v1/vulnerabilities/top", nil, &result); err != nil {
				return fmt.Errorf("failed to get top vulnerabilities: %w", err)
			}

			return printOutput(result)
		},
	}
}
