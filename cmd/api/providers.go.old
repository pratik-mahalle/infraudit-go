package main

import (
	"encoding/json"
	"net/http"
	"time"

	"infraaudit/backend/internal/db"

	"github.com/go-chi/chi/v5"
)

// registerProviderRoutes wires cloud provider account routes and connect/sync endpoints
func registerProviderRoutes(r *chi.Mux) {
	// Cloud Providers API (persisted)
	r.Get("/api/cloud-providers", func(w http.ResponseWriter, r *http.Request) {
		uid := int64(1)
		rows, err := repo.GetProviderAccounts(r.Context(), uid)
		if err != nil {
			writeJSON(w, http.StatusInternalServerError, map[string]string{"message": "db error"})
			return
		}
		list := []*CloudProviderAccount{}
		for _, p := range rows {
			var ls *time.Time
			if p.LastSynced.Valid {
				v := p.LastSynced.Time
				ls = &v
			}
			list = append(list, &CloudProviderAccount{
				ID:                    p.Provider,
				Name:                  map[string]string{"aws": "Amazon Web Services", "gcp": "Google Cloud Platform", "azure": "Microsoft Azure"}[p.Provider],
				IsConnected:           p.IsConnected,
				LastSynced:            ls,
				AWSAccessKeyID:        p.AWSAccessKeyID,
				AWSSecretAccessKey:    p.AWSSecretAccessKey,
				AWSRegion:             p.AWSRegion,
				GCPProjectID:          p.GCPProjectID,
				GCPServiceAccountJSON: p.GCPServiceAccount,
				GCPRegion:             p.GCPRegion,
				AzureTenantID:         p.AzureTenantID,
				AzureClientID:         p.AzureClientID,
				AzureClientSecret:     p.AzureClientSecret,
				AzureSubscriptionID:   p.AzureSubscriptionID,
				AzureLocation:         p.AzureLocation,
			})
		}
		writeJSON(w, http.StatusOK, list)
	})

	// Upsert provider account (persisted)
	r.With(requirePlanAtLeast("pro"), adminOnly).Post("/api/provider-accounts/{provider}", func(w http.ResponseWriter, r *http.Request) {
		uid := int64(1)
		provider := chi.URLParam(r, "provider")
		var body struct {
			IsConnected         *bool   `json:"isConnected"`
			LastSynced          *string `json:"lastSynced"`
			AWSAccessKeyID      *string `json:"awsAccessKeyId"`
			AWSSecretAccessKey  *string `json:"awsSecretAccessKey"`
			AWSRegion           *string `json:"awsRegion"`
			GCPProjectID        *string `json:"gcpProjectId"`
			GCPServiceAccount   *string `json:"gcpServiceAccountJson"`
			GCPRegion           *string `json:"gcpRegion"`
			AzureTenantID       *string `json:"azureTenantId"`
			AzureClientID       *string `json:"azureClientId"`
			AzureClientSecret   *string `json:"azureClientSecret"`
			AzureSubscriptionID *string `json:"azureSubscriptionId"`
			AzureLocation       *string `json:"azureLocation"`
		}
		_ = json.NewDecoder(r.Body).Decode(&body)
		isConn := true
		if body.IsConnected != nil {
			isConn = *body.IsConnected
		}
		row := db.ProviderAccountRow{
			UserID:      uid,
			Provider:    provider,
			IsConnected: isConn,
		}
		if body.AWSAccessKeyID != nil {
			row.AWSAccessKeyID = *body.AWSAccessKeyID
		}
		if body.AWSSecretAccessKey != nil {
			row.AWSSecretAccessKey = *body.AWSSecretAccessKey
		}
		if body.AWSRegion != nil {
			row.AWSRegion = *body.AWSRegion
		}
		if body.GCPProjectID != nil {
			row.GCPProjectID = *body.GCPProjectID
		}
		if body.GCPServiceAccount != nil {
			row.GCPServiceAccount = *body.GCPServiceAccount
		}
		if body.GCPRegion != nil {
			row.GCPRegion = *body.GCPRegion
		}
		if body.AzureTenantID != nil {
			row.AzureTenantID = *body.AzureTenantID
		}
		if body.AzureClientID != nil {
			row.AzureClientID = *body.AzureClientID
		}
		if body.AzureClientSecret != nil {
			row.AzureClientSecret = *body.AzureClientSecret
		}
		if body.AzureSubscriptionID != nil {
			row.AzureSubscriptionID = *body.AzureSubscriptionID
		}
		if body.AzureLocation != nil {
			row.AzureLocation = *body.AzureLocation
		}
		if err := repo.UpsertProviderAccount(r.Context(), row); err != nil {
			writeJSON(w, http.StatusInternalServerError, map[string]string{"message": "db error"})
			return
		}
		writeJSON(w, http.StatusOK, map[string]any{"status": "upserted", "provider": provider})
	})

	// Delete provider account (persisted)
	r.With(requirePlanAtLeast("pro"), adminOnly).Delete("/api/provider-accounts/{provider}", func(w http.ResponseWriter, r *http.Request) {
		uid := int64(1)
		provider := chi.URLParam(r, "provider")
		if err := repo.DeleteProviderAccount(r.Context(), uid, provider); err != nil {
			writeJSON(w, http.StatusInternalServerError, map[string]string{"message": "db error"})
			return
		}
		writeJSON(w, http.StatusOK, map[string]string{"status": "deleted"})
	})

	// Connect/sync/disconnect endpoints
	r.With(requirePlanAtLeast("pro"), adminOnly).Post("/api/cloud-providers/aws", handleConnect("aws"))
	r.With(requirePlanAtLeast("pro"), adminOnly).Post("/api/cloud-providers/gcp", handleConnect("gcp"))
	r.With(requirePlanAtLeast("pro"), adminOnly).Post("/api/cloud-providers/azure", handleConnect("azure"))
	r.With(requirePlanAtLeast("pro")).Post("/api/cloud-providers/{id}/sync", handleSyncProvider)
	r.With(requirePlanAtLeast("pro"), adminOnly).Delete("/api/cloud-providers/{id}", handleDisconnect)
}
